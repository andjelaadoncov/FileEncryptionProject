@page "/file-exchange"

@using CryptographyWebApp.Services
@inject FileExchangeService FileExchangeService

<h3>File Exchange</h3>

<label>Server Port:</label>
<input type="number" @bind="ServerPort" min="1024" max="65535" />
<button @onclick="StartServer">Start as Server</button>

<br />

<label>Server IP:</label>
<input type="text" @bind="ServerIpAddress" placeholder="Enter server IP" />

<label>Port:</label>
<input type="number" @bind="ClientPort" min="1024" max="65535" />

<InputFile OnChange="OnFileChange" />
<button @onclick="SendFile" disabled="@(selectedFilePath == null)">Send File</button>

@code {
    private int ServerPort = 12345;
    private string ServerIpAddress = "127.0.0.1";
    private int ClientPort = 12345;
    private string selectedFilePath;

    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var tempPath = Path.GetTempFileName();

        using (var stream = file.OpenReadStream())
        using (var fileStream = File.Create(tempPath))
        {
            await stream.CopyToAsync(fileStream);
        }

        selectedFilePath = tempPath;
        Console.WriteLine($"File selected: {selectedFilePath}");
    }

    private async Task SendFile()
    {
        if (string.IsNullOrEmpty(selectedFilePath))
        {
            Console.WriteLine("No file selected.");
            return;
        }

        await FileExchangeService.SendFile(ServerIpAddress, ClientPort, selectedFilePath);
    }

    private async Task StartServer()
    {
        await FileExchangeService.StartServer(ServerPort);
    }
}
